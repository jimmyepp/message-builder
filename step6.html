<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Step 6: Pick Supporting Points</title>
    <meta charset="UTF-8">
  <title>Step 1</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="centered-content">
  <div class="wrapper">
  <h1>Step 6 of 7</h1>

  <h2>Your Message So Far</h2>
  <p><strong>Audience:</strong> <span id="audience"></span></p>
  <p><strong>Topic:</strong> <span id="topic"></span></p>
  <p><strong>Recommendation:</strong> <span id="recommendation"></span></p>

  <h3>Select the 3 strongest points that support your recommendation:</h3>

<form id="step6Form" onsubmit="event.preventDefault(); nextStep();">    <ul id="supportingPointsList"></ul>
    <button type="submit">Next</button>
  </form>
</div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const draftId = new URLSearchParams(window.location.search).get("draftId");
    const draftKey = `draft-${draftId}`;
    const draft = JSON.parse(localStorage.getItem(draftKey)) || {};

    const uniquePoints = draft.uniquePoints || [];
    const benefitPoints = draft.benefits || []; // ← updated to match Step 5
const combinedPoints = [...uniquePoints, ...benefitPoints];

    // Debug output
    console.log("Draft loaded in Step 6:", draft);

    document.getElementById('audience').textContent = draft.audience || '[Not set]';
    document.getElementById('topic').textContent = draft.topic || '[Not set]';
    document.getElementById('recommendation').textContent = draft.recommendation || '[Not set]';

    const list = document.getElementById('supportingPointsList');

    combinedPoints.forEach((point, index) => {
      const li = document.createElement('li');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = point;
      checkbox.id = `point-${index}`;

      const label = document.createElement('label');
      label.htmlFor = `point-${index}`;
      label.textContent = point;

      li.appendChild(checkbox);
      li.appendChild(label);
      list.appendChild(li);
    });

    function saveToDraft(updates) {
      const updated = { ...draft, ...updates };
      localStorage.setItem(draftKey, JSON.stringify(updated));
    }

    window.nextStep = function () {
      const selected = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

      if (selected.length !== 3) {
        alert("Please select exactly 3 supporting points.");
        return;
      }

      saveToDraft({ supportingPoints: selected });
      window.location.href = `step7.html?draftId=${draftId}`;
    }
  });
</script>


<script type="module">
  import { db } from './firebase.js';
  import { doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

  export async function saveDraftToFirestore(draftId, updates) {
    const userId = localStorage.getItem('userId');
    if (!userId || !draftId) return;

    const draftKey = `draft-${draftId}`;
    const existingDraft = JSON.parse(localStorage.getItem(draftKey)) || {};
    const updatedDraft = { ...existingDraft, ...updates };

    // Save to localStorage
    localStorage.setItem(draftKey, JSON.stringify(updatedDraft));

    // Save to Firestore
    await setDoc(doc(db, "users", userId, "drafts", draftId), {
      ...updatedDraft,
      updatedAt: serverTimestamp()
    });

    console.log("Draft updated in Firestore with supportingPoints");
  }

  // Attach to window so regular script block can call it
  window.saveDraftToFirestore = saveDraftToFirestore;
</script>






</body>
</html>
