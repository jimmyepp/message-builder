<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Drafts</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrapper">
    <h1>My Saved Drafts</h1>
    <p style="margin-bottom: 1rem; font-size: 0.9rem;">Click any draft to resume editing or review your generated message.</p>
    <ul id="draftList" style="list-style: none; padding: 0;"></ul>
    <p id="status" style="margin-top: 1rem;"></p>
  </div>

  <script type="module">
    if (!localStorage.getItem('userId')) {
      window.location.href = 'login.html';
    }

    import { db } from './firebase.js';
    import {
      collection,
      getDocs,
      query,
      orderBy,
      doc,
      getDoc,
      deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

    const userId = localStorage.getItem('userId');
    const draftList = document.getElementById('draftList');
    const status = document.getElementById('status');

    if (!userId) {
      status.textContent = "You're not logged in.";
    } else {
      loadDrafts();
    }

    async function loadDrafts() {
      try {
        const q = query(collection(db, "users", userId, "drafts"), orderBy("lastEditedAt", "desc"));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          status.textContent = "No drafts found.";
          return;
        }

        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const draftId = docSnap.id;
          const isComplete = data.generatedMessage && data.generatedMessage.trim() !== "";

          const li = document.createElement('li');
          li.style.borderBottom = "1px solid #ccc";
          li.style.padding = "1rem 0";
          li.style.display = "flex";
          li.style.justifyContent = "space-between";
          li.style.alignItems = "center";

          const summaryDiv = document.createElement('div');
          summaryDiv.style.cursor = "pointer";
          summaryDiv.onclick = () => resumeDraft(draftId);

          const summary = `
            <div>
              <strong>${data.title || data.topic || 'Untitled Draft'}</strong>
              ${isComplete
                ? '<span style="color: green; font-weight: normal;">üü¢ Complete</span>'
                : '<span style="color: orange; font-weight: normal;">üìù In Progress</span>'}
            </div>
            <div style="margin-top: 0.25rem;">
              <small>${data.recommendation || 'No recommendation provided.'}</small>
            </div>
            <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #666;">
              Last edited: ${data.lastEditedAt?.seconds
                ? new Date(data.lastEditedAt.seconds * 1000).toLocaleString()
                : 'Unknown'}
            </div>
          `;
          summaryDiv.innerHTML = summary;

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'üóëÔ∏è';
          deleteBtn.style.marginLeft = '1em';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteDraft(draftId);
          };

          li.appendChild(summaryDiv);
          li.appendChild(deleteBtn);
          draftList.appendChild(li);
        });
      } catch (err) {
        status.textContent = "Failed to load drafts: " + err.message;
      }
    }

    async function resumeDraft(draftId) {
      try {
        const docRef = doc(db, "users", userId, "drafts", draftId);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          const data = snap.data();
          localStorage.setItem('messageDraft', JSON.stringify(data));

          // Go to Step 7 if it has a generated message
if (data.generatedMessages && Object.keys(data.generatedMessages).length > 0) {
  window.location.href = 'step7.html';
} else {
  window.location.href = 'step6.html';
}

        } else {
          alert("Draft not found.");
        }
      } catch (err) {
        alert("Failed to load draft: " + err.message);
      }
    }

    async function deleteDraft(draftId) {
      const confirmed = confirm("Are you sure you want to delete this draft?");
      if (!confirmed) return;

      try {
        await deleteDoc(doc(db, "users", userId, "drafts", draftId));
        alert("Draft deleted.");
        location.reload();
      } catch (err) {
        alert("Failed to delete: " + err.message);
      }
    }
  </script>
</body>
</html>
