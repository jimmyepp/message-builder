<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Drafts</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrapper">
    <h1>My Saved Drafts</h1>
    <ul id="draftList" style="list-style: none; padding: 0;"></ul>
    <p id="status" style="margin-top: 1rem;"></p>
  </div>

  <script type="module">
    import { db } from './firebase.js';
    import {
      collection,
      getDocs,
      query,
      orderBy,
      doc,
      getDoc,
      deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

    const userId = localStorage.getItem('userId');
    const draftList = document.getElementById('draftList');
    const status = document.getElementById('status');

    if (!userId) {
      status.textContent = "You're not logged in.";
    } else {
      loadDrafts();
    }

    async function loadDrafts() {
      try {
        const q = query(collection(db, "users", userId, "drafts"), orderBy("lastEditedAt", "desc"));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          status.textContent = "No drafts found.";
          return;
        }

        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const draftId = docSnap.id;

          const li = document.createElement('li');
          li.style.borderBottom = "1px solid #ccc";
          li.style.padding = "1rem 0";
          li.style.display = "flex";
          li.style.justifyContent = "space-between";
          li.style.alignItems = "center";

          const summaryDiv = document.createElement('div');
          summaryDiv.style.cursor = "pointer";
          summaryDiv.onclick = () => resumeDraft(draftId);

          const summary = `
            <strong>${data.title || data.topic || 'Untitled Draft'}</strong><br/>
            ${data.recommendation || 'No recommendation'}<br/>
            <em>Last edited: ${data.lastEditedAt?.seconds ? new Date(data.lastEditedAt.seconds * 1000).toLocaleString() : 'Unknown'}</em>
          `;
          summaryDiv.innerHTML = summary;

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'ðŸ—‘ï¸';
          deleteBtn.style.marginLeft = '1em';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteDraft(draftId);
          };

          li.appendChild(summaryDiv);
          li.appendChild(deleteBtn);
          draftList.appendChild(li);
        });
      } catch (err) {
        status.textContent = "Failed to load drafts: " + err.message;
      }
    }

    async function resumeDraft(draftId) {
      try {
        const docRef = doc(db, "users", userId, "drafts", draftId);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          localStorage.setItem('messageDraft', JSON.stringify(snap.data()));
          window.location.href = 'step6.html';
        } else {
          alert("Draft not found.");
        }
      } catch (err) {
        alert("Failed to load draft: " + err.message);
      }
    }

    async function deleteDraft(draftId) {
      const confirmed = confirm("Are you sure you want to delete this draft?");
      if (!confirmed) return;

      try {
        await deleteDoc(doc(db, "users", userId, "drafts", draftId));
        alert("Draft deleted.");
        location.reload();
      } catch (err) {
        alert("Failed to delete: " + err.message);
      }
    }
  </script>
</body>
</html>
