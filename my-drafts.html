<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Drafts</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrapper">
    <h1>My Saved Drafts</h1>
    <p style="margin-bottom: 1rem; font-size: 0.9rem;">Use the buttons below each draft to review or generate messages.</p>
    <ul id="draftList" style="list-style: none; padding: 0;"></ul>
    <p id="status" style="margin-top: 1rem;"></p>
  </div>

  <script type="module">
    if (!localStorage.getItem('userId')) {
      window.location.href = 'login.html';
    }

    import { db } from './firebase.js';
    import {
      collection,
      getDocs,
      query,
      orderBy,
      doc,
      getDoc,
      deleteDoc
    } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

    const userId = localStorage.getItem('userId');
    const draftList = document.getElementById('draftList');
    const status = document.getElementById('status');

    if (!userId) {
      status.textContent = "You're not logged in.";
    } else {
      loadDrafts();
    }

    async function loadDrafts() {
      try {
        const q = query(collection(db, "users", userId, "drafts"), orderBy("lastEditedAt", "desc"));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          status.textContent = "No drafts found.";
          return;
        }

        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const draftId = docSnap.id;

          const li = document.createElement('li');
          li.style.borderBottom = "1px solid #ccc";
          li.style.padding = "1rem 0";
          li.style.display = "flex";
          li.style.flexDirection = "column";
          li.style.gap = "0.5rem";

          const summaryDiv = document.createElement('div');
          summaryDiv.innerHTML = `
            <strong>${data.title || data.topic || 'Untitled Draft'}</strong><br>
            <small>${data.recommendation || 'No recommendation provided.'}</small><br>
            <span style="font-size: 0.85rem; color: #666;">Last edited: ${data.lastEditedAt?.seconds
              ? new Date(data.lastEditedAt.seconds * 1000).toLocaleString()
              : 'Unknown'}</span>
          `;

          const reviewBtn = document.createElement('button');
          reviewBtn.textContent = 'Step 6 Review';
          reviewBtn.onclick = () => {
            localStorage.setItem('messageDraft', JSON.stringify(data));
            window.location.href = `step6-review.html?draftId=${draftId}`;
          };

          const archiveBtn = document.createElement('button');
          archiveBtn.textContent = 'Framed Message Archive';
          archiveBtn.onclick = () => {
            window.location.href = `framed-message-archive.html?draftId=${draftId}`;
          };

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '🗑️ Delete';
          deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = confirm("Are you sure you want to delete this draft?");
            if (!confirmed) return;
            try {
              await deleteDoc(doc(db, "users", userId, "drafts", draftId));
              alert("Draft deleted.");
              location.reload();
            } catch (err) {
              alert("Failed to delete: " + err.message);
            }
          };

          li.appendChild(summaryDiv);
          li.appendChild(reviewBtn);
          li.appendChild(archiveBtn);
          li.appendChild(deleteBtn);
          draftList.appendChild(li);
        });
      } catch (err) {
        status.textContent = "Failed to load drafts: " + err.message;
      }
    }
  </script>
</body>
</html>
